package main

import (
	"context"
	"encoding/json"
	"fmt"
	"log"
	"os"

	"github.com/googleapis/go-genai/genai"
)

// 1. Define your struct (Use field tags to help the AI understand)
type RssAnalysis struct {
	Category  string   `json:"category" description:"One of: Tech, Politics, Finance, Other"`
	Sentiment string   `json:"sentiment" description:"Positive, Negative, or Neutral"`
	Keywords  []string `json:"keywords" description:"Up to 5 most relevant topics"`
	IsSpam    bool     `json:"is_spam" description:"True if the item looks like an ad or garbage"`
}

func main() {
	ctx := context.Background()

	// 2. Initialize Client (Unified SDK)
	client, err := genai.NewClient(ctx, &genai.ClientConfig{
		APIKey:  os.Getenv("GEMINI_API_KEY"),
		Backend: genai.BackendGeminiAPI, // Use VertexAI if you are on Google Cloud
	})
	if err != nil {
		log.Fatal(err)
	}

	// 3. Define the Schema (The "Blueprint")
	// This tells Gemini EXACTLY what fields to return.
	// It is stricter and cheaper than a text prompt instruction.
	schema := &genai.Schema{
		Type: genai.TypeObject,
		Properties: map[string]*genai.Schema{
			"category":  {Type: genai.TypeString, Enum: []string{"Tech", "Politics", "Finance", "Other"}},
			"sentiment": {Type: genai.TypeString, Enum: []string{"Positive", "Negative", "Neutral"}},
			"keywords":  {Type: genai.TypeArray, Items: &genai.Schema{Type: genai.TypeString}},
			"is_spam":   {Type: genai.TypeBoolean},
		},
		Required: []string{"category", "sentiment", "keywords", "is_spam"},
	}

	// 4. RSS Data
	rssTitle := "Go 1.25 Released"
	rssDesc := "The Go team has announced the release of Go 1.25."

	// 5. Call the API
	// usage of "gemini-2.0-flash" is currently the sweet spot for speed/cost
	resp, err := client.Models.GenerateContent(ctx, "gemini-2.0-flash",
		genai.Text(fmt.Sprintf("Title: %s\nDescription: %s", rssTitle, rssDesc)),
		&genai.GenerateContentConfig{
			ResponseMIMEType: "application/json",
			ResponseSchema:   schema,
			SystemInstruction: &genai.Content{
				Parts: []genai.Part{
					genai.Text("You are an RSS classifier. Classify the input strictly."),
				},
			},
			Temperature: DO_NOT_USE_POINTER_JUST_VALUE(0.0), // Set to 0 for consistency
		},
	)

	if err != nil {
		log.Fatal(err)
	}

	// 6. Parse Result
	// Gemini returns the JSON text in the first candidate
	var result RssAnalysis
	rawJSON := resp.Candidates[0].Content.Parts[0].(genai.Text)

	if err := json.Unmarshal([]byte(rawJSON), &result); err != nil {
		log.Fatalf("JSON Parse Error: %v", err)
	}

	fmt.Printf("Category: %s\nSpam: %v\n", result.Category, result.IsSpam)
}

// Helper to handle pointer types in config if needed (pseudo-code representation)
func DO_NOT_USE_POINTER_JUST_VALUE(v float64) *float64 { return &v }


/*
Yes, you absolutely can. Google offers a generous **Free Tier** for the Gemini API that is perfect for what you are trying to do (testing RSS feeds without incurring costs).

### **How to get the Free API Key**
1.  Go to **[Google AI Studio](https://aistudio.google.com/)**.
2.  Sign in with your standard Google/Gmail account.
3.  Click the blue **"Get API key"** button on the top left.
4.  Click **"Create API key"** (select "Create in new project" if asked).
5.  Copy the key string starting with `AIza...`.

### **The "Catch" (Free Tier Limits)**
Since you are on the free plan, there are two main limitations to be aware of:
1.  **Rate Limits:** You are limited to **15 requests per minute** (RPM) and **1,500 requests per day** for the *Gemini 2.0 Flash* model. This should be plenty for processing RSS feeds unless you are doing a massive historical backfill.
2.  **Data Privacy:** On the *Free Tier*, Google reserves the right to use your inputs and outputs to **train their models**.
    *   *If your RSS feeds contain sensitive, private, or proprietary data, do NOT use the free key.*
    *   *If the data is public (like news articles or blog posts), this usually doesn't matter.*

### **Which Model to Select?**
In your Go code, ensure you use the model string that corresponds to the free tier options visible in AI Studio.
*   **Best for you:** `gemini-2.0-flash` (Fast, cheap/free, supports the schema enforcement feature I showed you).

If you eventually add a billing account to that project in the Google Cloud Console, it automatically switches to the "Pay-as-you-go" tier (where data is private and rate limits are higher), but it stays free as long as you don't add a credit card.
*/