package main

import (
	"context"
	"encoding/json"
	"fmt"
	"os"

	"github.com/openai/openai-go"
	"github.com/openai/openai-go/option"
)

// Define your target structure to keep it strict
type RssAnalysis struct {
	Category  string   `json:"category"`
	Sentiment string   `json:"sentiment"`
	Keywords  []string `json:"keywords"`
	IsSpam    bool     `json:"is_spam"`
}

func main() {
	client := openai.NewClient(
		option.WithAPIKey(os.Getenv("DEEPSEEK_API_KEY")),
		option.WithBaseURL("https://api.deepseek.com"),
	)

	// TIP: Providing the schema in the prompt saves money because
	// the model doesn't "guess" keys, it just fills them.
	const systemInstruction = `
		You are an RSS analyzer.
		Analyze the user input and return a JSON object.
		The JSON must match this schema:
		{
			"category": "Tech" | "Politics" | "Finance" | "Other",
			"sentiment": "Positive" | "Negative" | "Neutral",
			"keywords": ["list", "of", "keywords"],
			"is_spam": boolean
		}
	`

	rssTitle := "Go 1.25 Released"
	rssDesc := "The Go team has announced the release of Go 1.25."

	completion, err := client.Chat.Completions.New(context.TODO(), openai.ChatCompletionNewParams{
		Model: openai.String("deepseek-chat"), // Use V3 for best JSON performance

		// !!! VITAL SETTING BELOW !!!
		// This forces the model to output valid JSON syntax only.
		ResponseFormat: openai.F[openai.ChatCompletionNewParamsResponseFormatUnion](
			openai.ChatCompletionNewParamsResponseFormatJSONObjectParam{
				Type: openai.F(openai.ChatCompletionNewParamsResponseFormatJSONObjectTypeJSONObject),
			},
		),

		Messages: openai.F([]openai.ChatCompletionMessageParamUnion{
			openai.SystemMessage(systemInstruction),
			openai.UserMessage(fmt.Sprintf("Title: %s\nDescription: %s", rssTitle, rssDesc)),
		}),
	})

	if err != nil {
		panic(err)
	}

	// The content is a string containing JSON
	jsonString := completion.Choices[0].Message.Content

	// Unmarshal into your Go struct
	var result RssAnalysis
	if err := json.Unmarshal([]byte(jsonString), &result); err != nil {
		fmt.Printf("Error parsing JSON: %v\n", err)
		return
	}

	fmt.Printf("Category: %s\nKeywords: %v\n", result.Category, result.Keywords)
}
